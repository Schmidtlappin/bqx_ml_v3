{
  "project": {
    "name": "BQX ML V3",
    "version": "3.1.0",
    "description": "588 ML models (28 pairs × 7 horizons × 3 ensemble) for forex momentum prediction using BQX paradigm",
    "repository": "https://github.com/Schmidtlappin/bqx_ml_v3",
    "owner": "Schmidtlappin",
    "created": "2024-11-24",
    "last_updated": "2025-12-10"
  },
  "paradigm": {
    "name": "BQX Momentum Prediction",
    "description": "BQX values serve as BOTH features AND targets for autoregressive prediction",
    "paradigm_shift_date": "2024-11-24",
    "core_principle": "Historical BQX values contain momentum signals that predict future BQX"
  },
  "architecture": {
    "type": "Multi-Horizon Ensemble Architecture",
    "total_models": 588,
    "calculation": "28 pairs × 7 horizons × 3 ensemble members (ElasticNet removed per EA-001)",
    "horizons": ["h15", "h30", "h45", "h60", "h75", "h90", "h105"],
    "ensemble_members": ["LightGBM", "XGBoost", "CatBoost"],
    "meta_learner": "LogisticRegression (regime-aware)",
    "model_scope": "One ensemble per pair-horizon combination",
    "isolation": "Complete - no cross-pair contamination",
    "computation": "Interval-centric using ROWS BETWEEN only",
    "deployment_strategy": "Deploy farthest horizon achieving ≥95% accuracy per pair"
  },
  "infrastructure": {
    "cloud": {
      "provider": "Google Cloud Platform",
      "project_id": "bqx-ml",
      "compute_instance": "bqx-ml-master",
      "zone": "us-east1-b",
      "ip": "34.148.152.67"
    },
    "data": {
      "warehouse": "BigQuery",
      "location": "us-central1",
      "migration_date": "2025-12-08",
      "v2_migration_status": "COMPLETE (100%)",
      "v2_catalog": "/intelligence/bigquery_v2_catalog.json",
      "datasets_v2": {
        "bqx_bq_uscen1_v2": "Source data (2,210 tables, 131 GB)",
        "bqx_ml_v3_features_v2": "Engineered features (4,888 tables, 1,479 GB)",
        "bqx_ml_v3_analytics_v2": "Target tables (54 tables, 68 GB)",
        "bqx_ml_v3_models": "Trained models (READY for training)",
        "bqx_ml_v3_predictions": "Model predictions (READY)"
      },
      "datasets_v1_deleted": {
        "bqx_bq_uscen1": "DELETED 2025-12-09 (was 1,220 GB)",
        "bqx_ml_v3_features": "DELETED 2025-12-09 (was 1,279 GB)"
      },
      "v2_partitioning": {
        "partition_by": "DATE(interval_time)",
        "cluster_by": "pair (or pair1 for covariance tables)"
      },
      "storage_summary": {
        "v2_total_gb": 1678,
        "monthly_cost": "$33.57",
        "v1_deleted_gb": 2499,
        "monthly_savings_realized": "$49.98"
      }
    },
    "project_management": {
      "tool": "AirTable",
      "project_id": "MP03",
      "base_id": "appR3PPnrNkVo48mO",
      "phases": 11,
      "stages": 70,
      "completion": "29%"
    },
    "version_control": {
      "platform": "GitHub",
      "repository": "Schmidtlappin/bqx_ml_v3",
      "branch": "main",
      "secrets": 4
    },
    "backup": {
      "purpose": "Disaster recovery and business continuity",
      "mandate_reference": "/intelligence/backup_mandate.json",
      "working_backup": {
        "provider": "Google Drive",
        "remote": "gdrive:bqx_ml_v3",
        "tool": "rclone",
        "script": "scripts/sync-bqx-project.sh",
        "role": "Working backup - FILES ONLY",
        "limitations": "Storage quota limits, part of GCP infrastructure",
        "disaster_recovery": false,
        "status": "ACTIVE"
      },
      "disaster_recovery": {
        "provider": "Box.com",
        "folder_id": "353414610676",
        "folder_name": "bqx-ml-v3",
        "auth_method": "JWT",
        "tool": "Box SDK (box_sdk_gen)",
        "scripts": {
          "files": "scripts/sync-box-backup.py",
          "bigquery": "scripts/export-bq-to-box.py"
        },
        "role": "TRUE disaster recovery - FILES AND BigQuery tables",
        "advantages": "Unlimited storage, independent from GCP",
        "disaster_recovery": true,
        "status": "ACTIVE",
        "configured_date": "2025-11-28"
      },
      "cloud_run_automation": {
        "service_name": "bq-to-box-sync",
        "service_url": "https://bq-to-box-sync-499681702492.us-central1.run.app",
        "container_image": "gcr.io/bqx-ml/bq-to-box-sync:latest",
        "region": "us-central1",
        "service_account": "bq-to-box-sync@bqx-ml.iam.gserviceaccount.com",
        "memory": "2Gi",
        "timeout": "3600s",
        "status": "DEPLOYED",
        "deployed_date": "2025-11-29",
        "scheduled_jobs": {
          "bq-to-box-models": "Daily 2 AM UTC (bqx_ml_v3_models)",
          "bq-to-box-features": "Weekly Sunday 3 AM UTC (bqx_ml_v3_features)",
          "bq-to-box-predictions": "Weekly Monday 4 AM UTC (bqx_ml_v3_predictions)",
          "bq-to-box-analytics": "Monthly 1st 5 AM UTC (bqx_ml_v3_analytics_v2)"
        },
        "cost_monthly": "$0.40-3.24",
        "documentation": "/docs/CLOUD_RUN_BOX_BACKUP.md"
      },
      "sync_protocol": {
        "on_user_request": "Sync files to BOTH GDrive AND Box.com",
        "automated_bigquery": "Cloud Run exports BQ tables to Box.com on schedule (ACTIVE)",
        "bigquery_backup": "Export BQ tables to Box.com ONLY (too large for GDrive)"
      },
      "execution_model": {
        "file_sync": "Fast (minutes) - non-blocking",
        "bigquery_backup_manual": "Background process (4-8 hours) - non-blocking",
        "bigquery_backup_automated": "Cloud Run scheduled exports - fully automated"
      },
      "key_rationale": "GDrive is part of GCP - if GCP fails, GDrive may be inaccessible. Box.com is completely independent and can store TB-scale BQ exports."
    }
  },
  "currency_pairs": [
    "EURUSD", "GBPUSD", "USDJPY", "USDCHF", "AUDUSD", "USDCAD", "NZDUSD",
    "EURGBP", "EURJPY", "EURCHF", "EURAUD", "EURCAD", "EURNZD",
    "GBPJPY", "GBPCHF", "GBPAUD", "GBPCAD", "GBPNZD",
    "AUDJPY", "AUDCHF", "AUDCAD", "AUDNZD",
    "NZDJPY", "NZDCHF", "NZDCAD",
    "CADJPY", "CADCHF",
    "CHFJPY"
  ],
  "team": {
    "role": "BQXML Chief Engineer",
    "environment": "bqx-ml-master GCP instance",
    "primary_tools": ["Python", "BigQuery", "Vertex AI", "AirTable", "Claude Code"]
  },
  "agent_coordination": {
    "version": "3.0",
    "last_updated": "2025-12-10",
    "registry_file": "/.claude/sandbox/communications/AGENT_REGISTRY.json",
    "session_file_location": "/home/micha/.claude/projects/-home-micha-bqx-ml-v3/",
    "active_agents": {
      "CE": {
        "full_name": "Chief Engineer",
        "status": "ACTIVE",
        "current_session_id": "b2360551-04af-4110-9cc8-cb1dce3334cc",
        "charge_document": "/.claude/sandbox/communications/active/CE_CHARGE_20251210.md"
      },
      "BA": {
        "full_name": "Build Agent",
        "status": "ACTIVE",
        "current_session_id": "72a1c1a7-c564-4ac8-974a-13ed0ce87dca",
        "charge_document": "/.claude/sandbox/communications/active/BA_CHARGE_20251210.md"
      },
      "QA": {
        "full_name": "Quality Assurance Agent",
        "status": "ACTIVE",
        "current_session_id": "c31dd28b-2f5b-4f93-a3ad-1a9f0fe74dbc",
        "charge_document": "/.claude/sandbox/communications/active/QA_CHARGE_20251209.md"
      },
      "EA": {
        "full_name": "Enhancement Assistant",
        "status": "ACTIVE",
        "current_session_id": "b959d344-c727-4cd9-9fe9-53d8e2dac32f",
        "charge_document": "/.claude/sandbox/communications/active/EA_CHARGE_20251209.md"
      }
    },
    "session_continuity": {
      "protocol": "See AGENT_ONBOARDING_PROMPTS.md for recovery procedures",
      "common_errors": ["thinking blocks cannot be modified", "unexpected tool_use_id", "Prompt is too long"],
      "recovery_action": "Archive corrupted session, start new session with onboarding prompt, ingest predecessor context"
    }
  },
  "current_phase": {
    "phase": "Enhanced Stacking Architecture (V2)",
    "name": "Calibrated Probability Stacking with Regime-Aware Meta-Learner",
    "status": "IN PROGRESS - Step 6 feature extraction (28 pairs)",
    "start_date": "2025-12-09",
    "roadmap_version": "2.0",
    "roadmap_file": "/intelligence/roadmap_v2.json",
    "completed_milestones": [
      "V2 migration complete (4,888 feature tables)",
      "Row count parity validated",
      "V1 datasets deleted ($50/month savings realized)",
      "All tables partitioned and clustered",
      "GATE_1, GATE_2, GATE_3 passed",
      "h15 baseline trained (59 features - OBSOLETE)",
      "ElasticNet removal (EA-001) - 784 → 588 models"
    ],
    "next_milestones": [
      "Step 6 feature extraction (28 pairs × 11,337 columns)",
      "Stability selection (select ~200-600 from 1,064 unique features)",
      "Retrain h15 with expanded feature universe",
      "SHAP analysis (100K+ samples - USER MANDATE)"
    ],
    "pipeline_status": {
      "step_6_feature_extraction": "READY - Gap remediation COMPLETE (2025-12-11)",
      "stability_selection": "PENDING",
      "training": "PENDING",
      "shap": "PENDING"
    },
    "feature_extraction": {
      "tables_per_pair": 669,
      "categories": 5,
      "extraction_categories": {
        "pair_specific": {"pattern": "%pair%", "tables": 256},
        "triangulation": {"pattern": "tri_*", "tables": 194},
        "market_wide": {"pattern": "mkt_*", "tables": 12},
        "variance": {"pattern": "var_*", "tables": 63},
        "currency_strength": {"pattern": "csi_*", "tables": 144}
      },
      "coverage": "100%",
      "gap_remediation_date": "2025-12-11"
    },
    "feature_universe": {
      "total_columns_per_pair": 11337,
      "unique_features_per_pair": 1064,
      "tables_per_pair": 669,
      "current_h15_features": 59,
      "h15_model_status": "OBSOLETE - will be replaced after Step 6"
    },
    "active_plan": "/home/micha/.claude/plans/gentle-skipping-wirth.md",
    "target_accuracy": {
      "overall": "85-90%",
      "called_signals": "90-95%",
      "coverage": "30-50%"
    }
  },
  "polynomial_regression": {
    "status": "CRITICAL_GAP_IDENTIFIED",
    "gap_analysis": "/mandate/POLYNOMIAL_REGRESSION_FEATURE_GAP_ANALYSIS.md",
    "specification": "/features/POLYNOMIAL_REG_FEATURES.md",
    "formula": {
      "equation": "y = β₂x² + β₁x + β₀",
      "x_definition": "np.arange(W) = [0, 1, 2, ..., W-1]",
      "y_definition": "values[-W:] = last W values (close price for IDX, BQX for BQX)",
      "fit_method": "np.polyfit(x, y, 2) → [β₂, β₁, β₀]"
    },
    "user_mandate_v21": {
      "source": "AirTable MP02.P16.S01",
      "description": "Endpoint Evaluation at x = W (NOT raw coefficients)",
      "quad_term": "β₂ × W² - scaled quadratic at endpoint",
      "lin_term": "β₁ × W - scaled linear at endpoint",
      "const_term": "β₀ - constant term (unchanged)",
      "residual": "rate - (quad_term + lin_term + const_term)",
      "rate": "y[-1] (current value, last in window)"
    },
    "windows": [45, 90, 180, 360, 720, 1440, 2880],
    "new_columns_per_window": 19,
    "total_new_columns": 133,
    "tables_to_rebuild": 492,
    "tables_breakdown": {
      "reg_*": 28,
      "reg_bqx_*": 28,
      "cov_reg_*": 168,
      "cov_reg_bqx_*": 168,
      "var_reg_*": 28,
      "csi_reg_*": 32,
      "tri_reg_*": 36,
      "mkt_reg*": 4
    },
    "variants": {
      "IDX": "Price-derived (close price polynomial fit)",
      "BQX": "Momentum-derived (BQX oscillator polynomial fit)"
    },
    "ba_directive": "/.claude/sandbox/communications/outboxes/CE/20251129_1930_CE-to-BA_POLYNOMIAL_REGRESSION_IMPLEMENTATION.md"
  },
  "correlation_analysis": {
    "current_features": 1064,
    "total_columns": 11337,
    "targets": 49,
    "target_formula": "7 windows × 7 horizons",
    "methodology": "Pooled Pearson correlation at extreme BQX points (|BQX_45| > 2σ)",
    "extreme_count": 5000,
    "strategy_expansion": "/mandate/CORRELATION_STRATEGY_EXPANSION.md",
    "top_performers": {
      "reg_slope_720": 0.9709,
      "mom_diff_720": 0.9702,
      "der_v1_720": 0.9702,
      "bqx_720": 0.9689,
      "mom_roc_720": 0.9689
    },
    "expected_polynomial_performers": [
      "reg_lin_term_720 (β₁ × 720 - scaled linear at endpoint)",
      "reg_quad_term_720 (β₂ × 720² - scaled quadratic at endpoint)",
      "reg_residual_720 (rate - (quad_term + lin_term + const_term))",
      "reg_forecast_5_720 (direct prediction)",
      "reg_acceleration_720 (reversal detection)",
      "reg_trend_str_720 (normalized trend)"
    ]
  },
  "recent_milestones": {
    "2025-12-09": [
      "Roadmap V2 complete - Enhanced Stacking Architecture",
      "Robust feature selection complete (399 stable features)",
      "6 critical stacking fixes defined (OOF, calibration, regime, diversity, gating)",
      "Feature selection replaces naive SHAP with Group-First Stability Selection",
      "V1 datasets deleted ($50/month savings realized)",
      "Created pipelines: stack_calibrated.py, feature_selection_robust.py"
    ],
    "2025-12-08": [
      "BigQuery V2 migration in progress (partitioned by DATE(interval_time), clustered by pair)",
      "Source v2 migration COMPLETE (2,209 tables - 100%)",
      "Regime migration COMPLETE (354 tables - 100%)",
      "Covariance migration IN PROGRESS (1,299/2,352 - 55%)",
      "Features v2 migration IN PROGRESS (~2,609/4,218 - 62%)",
      "Multi-horizon architecture finalized: 784 models (28 × 7 × 4)",
      "Prediction strategy: h15-h105, deploy farthest achieving 95%+",
      "Algorithm ensemble: LightGBM + XGBoost + CatBoost → Meta-learner",
      "Cost optimization: ~$277/month (BigQuery ML, Spot VMs, Coldline)",
      "Walk-forward validation mandatory for time series",
      "Post-migration plan: gentle-skipping-wirth.md",
      "Archived 6 outdated plan files"
    ],
    "2025-12-07": [
      "Started BigQuery restructure migration to v2 datasets",
      "Created migration scripts for all table types",
      "Created real-time migration monitor (monitor_all.sh)"
    ],
    "2025-11-29": [
      "CRITICAL: Identified polynomial regression feature gap (492 tables)",
      "Created feature specifications for reg_, cov_reg_, var_reg_, csi_reg_, tri_reg_, mkt_reg_",
      "Deployed BQ-to-Box Cloud Run service for automated disaster recovery"
    ],
    "2025-11-28": [
      "Completed BigQuery migration to us-central1 (2,463 tables)",
      "40-95x performance speedup from us-central1 migration"
    ],
    "2024-11-24": [
      "BQX paradigm shift: BQX as both features AND targets",
      "Project inception and architecture design"
    ]
  },
  "critical_context": {
    "v2_migration": {
      "status": "COMPLETE",
      "features_v2": "bqx_ml_v3_features_v2 (4,888 tables, 1,479 GB)",
      "source_v2": "bqx_bq_uscen1_v2 (2,210 tables, 131 GB)",
      "analytics_v2": "bqx_ml_v3_analytics_v2 (54 tables, 68 GB)",
      "partitioning": "DATE(interval_time)",
      "clustering": "pair (or pair1 for covariance)",
      "v1_deleted": "2025-12-09 (2,499 GB freed, $50/month saved)",
      "completion_date": "2025-12-09"
    },
    "model_architecture": {
      "version": "2.0 - Enhanced Stacking",
      "total_models": 588,
      "calculation": "28 pairs × 7 horizons × 3 ensemble members (ElasticNet removed)",
      "horizons": ["h15", "h30", "h45", "h60", "h75", "h90", "h105"],
      "ensemble": ["LightGBM", "XGBoost", "CatBoost"],
      "meta_learner": "Logistic Regression + Regime Features",
      "deployment_criterion": "Farthest horizon achieving ≥95% called accuracy",
      "feature_universe": {
        "total_columns": 11337,
        "unique_features": 1064,
        "current_h15_model": "59 features (OBSOLETE)"
      },
      "feature_selection": "Stability Selection (select ~200-600 from 1,064 unique features)",
      "stacking_architecture": {
        "stage_a": "Sign Probability Stack (calibrated P(+))",
        "stage_b": "Conditional Magnitude (after sign decided)"
      },
      "critical_fixes": [
        "Walk-forward OOF predictions (no leakage)",
        "Probability calibration (Platt scaling)",
        "Regime-aware meta-learner",
        "Feature-view diversity",
        "Confidence gating (called accuracy)"
      ]
    },
    "accuracy_target": {
      "primary": "95%+ directional accuracy (updated from 90%)",
      "per_horizon_expectation": {
        "h15": "94-98%",
        "h30": "91-96%",
        "h45": "88-94%",
        "h60": "85-92%",
        "h75": "82-90%",
        "h90": "78-88%",
        "h105": "75-85%"
      }
    },
    "cost_optimization": {
      "monthly_estimate": "$277 (optimized)",
      "savings": "63% vs original ($755)",
      "strategies": ["BigQuery ML (vs Vertex AI)", "Spot VMs", "Feature selection FIRST", "Coldline backup"]
    },
    "validation_requirements": {
      "walk_forward": "MANDATORY - no standard cross-validation for time series",
      "train_window": "T-365 to T-30 days",
      "validation_window": "T-30 to T-7 days",
      "test_window": "T-7 to T days"
    }
  }
}
