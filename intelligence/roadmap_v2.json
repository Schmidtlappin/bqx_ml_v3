{
  "roadmap_version": "2.2.0",
  "created": "2025-12-09",
  "updated": "2025-12-09",
  "status": "ACTIVE",
  "supersedes": "v2.1.0 (added gap remediation phases, user mandates, risk register)",
  "summary": {
    "objective": "Train 784 ML models achieving 85-95%+ directional accuracy with persistence",
    "architecture": "Calibrated Probability Stacking with Regime-Aware Meta-Learner",
    "target_accuracy": {
      "overall": "85-90%",
      "called_signals": "90-95%",
      "coverage": "30-50%"
    },
    "model_count": 784,
    "breakdown": "28 pairs x 7 horizons x 4 ensemble members"
  },
  "phases": {
    "phase_1": {
      "name": "Infrastructure (COMPLETE)",
      "status": "COMPLETE",
      "completion_date": "2025-12-09",
      "milestones": [
        {"item": "V2 Migration", "status": "COMPLETE", "details": "4,888 tables migrated, partitioned by DATE(interval_time)"},
        {"item": "V1 Deletion", "status": "COMPLETE", "details": "2,499 GB freed, $49.98/month savings"},
        {"item": "Row Parity Validation", "status": "COMPLETE", "details": "All tables validated"},
        {"item": "Performance Benchmark", "status": "COMPLETE", "details": "40-95x speedup achieved"}
      ]
    },
    "phase_1_5": {
      "name": "Feature Table Gap Remediation",
      "status": "IN_PROGRESS",
      "dependencies": ["phase_1"],
      "milestones": [
        {"item": "CSI Tables (Currency Strength)", "status": "PENDING", "count": 192, "priority": "CRITICAL", "details": "8 currencies × 12 feature types × 2 variants"},
        {"item": "VAR Tables (Variance)", "status": "PENDING", "count": 59, "priority": "HIGH", "details": "Missing variance features"},
        {"item": "MKT Tables (Market-wide)", "status": "PENDING", "count": 14, "priority": "MEDIUM", "details": "Missing market-wide features"}
      ],
      "total_gap_tables": 265,
      "execution_strategy": {
        "csi": "Proof of concept (USD first), then parallel 7 currencies",
        "var": "Parallel after CSI complete",
        "mkt": "Parallel after VAR complete"
      },
      "gate": {
        "name": "GATE_1",
        "criteria": "All 265 gap tables created and validated",
        "validation": ["Row count matches expected", "No NULL in required columns", "Partitioning applied"]
      },
      "contingency": {
        "failure_criteria": "Any table creation fails after 3 retries",
        "rollback_procedure": "Log failure, continue with others, report at checkpoint",
        "escalation_path": "Report to CE if >10% of tables fail"
      }
    },
    "phase_2": {
      "name": "Robust Feature Selection",
      "status": "COMPLETE",
      "completion_date": "2025-12-09",
      "methodology": "Group-First Stability Selection (replaces naive SHAP)",
      "milestones": [
        {"item": "Feature Discovery", "status": "COMPLETE", "details": "28 groups, 256 tables, 3,800+ columns"},
        {"item": "Safe Pruning", "status": "COMPLETE", "details": "Removed constant/duplicate features"},
        {"item": "Correlation Clustering", "status": "COMPLETE", "details": "Grouped features with |r| > 0.95"},
        {"item": "Stability Selection", "status": "COMPLETE", "details": "5 folds x 3 seeds, 50% frequency threshold (USER APPROVED 2025-12-09)"},
        {"item": "Ablation Testing", "status": "COMPLETE", "details": "Validated group importance by ΔAUC"}
      ],
      "results": {
        "stable_features": 607,
        "stable_features_note": "Updated from 399 after USER APPROVED 50% threshold (2025-12-09)",
        "idx_features": 168,
        "bqx_features": 270,
        "covariance_features": 35,
        "threshold_history": {
          "original": "60%",
          "approved": "50%",
          "approval_date": "2025-12-09",
          "features_recovered": 208
        },
        "output_file": "/intelligence/robust_feature_selection_eurusd_h15.json"
      }
    },
    "phase_2_5": {
      "name": "Feature Ledger Generation",
      "status": "PENDING",
      "dependencies": ["phase_1_5", "phase_2"],
      "milestones": [
        {"item": "Create generate_feature_ledger.py", "status": "PENDING", "details": "Script to enumerate all features per model"},
        {"item": "Generate initial ledger", "status": "PENDING", "details": "6,477 features × 28 pairs × 7 horizons = 1,269,492 rows"},
        {"item": "Validate 100% coverage", "status": "PENDING", "details": "Every feature has final_status"},
        {"item": "Run feature selection (50% threshold)", "status": "PENDING", "details": "Full universe testing with approved threshold"}
      ],
      "deliverables": {
        "primary": "feature_ledger.parquet",
        "documentation": "feature_ledger.md",
        "validation_report": "ledger_validation_report.md"
      },
      "gate": {
        "name": "GATE_2",
        "criteria": "Ledger has 100% coverage with valid final_status for all features",
        "validation": ["Row count = 1,269,492", "No NULL final_status", "SHAP values for all RETAINED features"]
      }
    },
    "phase_3": {
      "name": "Enhanced Stacking Architecture",
      "status": "COMPLETE",
      "completion_date": "2025-12-09",
      "objective": "Implement calibrated probability stacking for persistence",
      "milestones": [
        {"item": "Walk-Forward OOF Predictions", "status": "COMPLETE", "priority": "CRITICAL", "details": "5 folds with 30 interval embargo"},
        {"item": "Probability Calibration", "status": "COMPLETE", "priority": "HIGH", "details": "Platt scaling implemented"},
        {"item": "Regime-Aware Meta-Learner", "status": "COMPLETE", "priority": "HIGH", "details": "Added 6 regime features"},
        {"item": "Feature-View Diversity", "status": "PARTIAL", "priority": "MEDIUM", "details": "Base models trained, views to optimize"},
        {"item": "ElasticNet Base Model", "status": "COMPLETE", "priority": "LOW", "details": "Added for linear diversity"},
        {"item": "Confidence Gating", "status": "COMPLETE", "priority": "HIGH", "details": "Thresholds optimized: tau_70 recommended"}
      ],
      "results_eurusd_h15": {
        "overall_accuracy": 0.7690,
        "overall_auc": 0.8505,
        "oof_samples": 66515,
        "base_model_aucs": {
          "lightgbm": 0.8418,
          "xgboost": 0.8432,
          "catboost": 0.8510,
          "elasticnet": 0.4578
        },
        "gating_results": {
          "tau_55": {"accuracy": 0.7816, "coverage": 0.9530},
          "tau_60": {"accuracy": 0.7948, "coverage": 0.9036},
          "tau_65": {"accuracy": 0.8087, "coverage": 0.8499},
          "tau_70": {"accuracy": 0.8252, "coverage": 0.7884}
        },
        "recommended_threshold": "tau_70",
        "results_file": "/intelligence/calibrated_stack_eurusd_h15.json"
      },
      "implementation_files": {
        "stack_calibrated.py": "pipelines/training/stack_calibrated.py",
        "feature_selection_robust.py": "pipelines/training/feature_selection_robust.py",
        "train_multi_pair.py": "pipelines/training/train_multi_pair.py"
      }
    },
    "phase_4": {
      "name": "EURUSD Training Pipeline",
      "status": "READY",
      "strategy": "Test full pipeline on EURUSD before scaling",
      "milestones": [
        {"item": "Base Model Training", "status": "PENDING", "details": "LightGBM + XGBoost + CatBoost + ElasticNet"},
        {"item": "Meta-Learner Training", "status": "PENDING", "details": "Logistic regression on calibrated OOF"},
        {"item": "Horizon Evaluation", "status": "PENDING", "details": "Walk-forward for h15-h105"},
        {"item": "Confidence Threshold Optimization", "status": "PENDING", "details": "Find optimal τ+/τ- for coverage"}
      ],
      "models_per_horizon": 4,
      "total_eurusd_models": 28
    },
    "phase_5": {
      "name": "Scale to 28 Pairs",
      "status": "PENDING",
      "milestones": [
        {"item": "Major Pairs (5)", "status": "PENDING", "details": "EURUSD, GBPUSD, USDJPY, AUDUSD, USDCAD"},
        {"item": "Cross Pairs (15)", "status": "PENDING", "details": "EUR crosses, GBP crosses"},
        {"item": "Minor Pairs (8)", "status": "PENDING", "details": "Remaining pairs"}
      ],
      "total_models": 784
    },
    "phase_6": {
      "name": "Production Deployment",
      "status": "PENDING",
      "milestones": [
        {"item": "Model Serialization", "status": "PENDING", "details": "Save to GCS/BigQuery"},
        {"item": "Inference Pipeline", "status": "PENDING", "details": "Real-time prediction service"},
        {"item": "Monitoring Dashboard", "status": "PENDING", "details": "Accuracy tracking, drift detection"}
      ]
    }
  },
  "enhanced_stacking_architecture": {
    "version": "2.0",
    "baseline_accuracy": "75-79%",
    "target_accuracy": "85-95% (called signals)",
    "critical_fixes": {
      "fix_1_walk_forward_oof": {
        "problem": "Meta-learner trained on in-sample predictions causes leakage",
        "solution": "Generate OOF predictions from walk-forward splits with embargo gap",
        "embargo_intervals": 30,
        "priority": "CRITICAL"
      },
      "fix_2_calibration": {
        "problem": "Base model probabilities not comparable",
        "solution": "Platt scaling or isotonic regression on OOF data",
        "methods": ["platt", "isotonic"],
        "priority": "HIGH"
      },
      "fix_3_feature_view_diversity": {
        "problem": "GBMs on same features produce correlated outputs",
        "solution": "Different feature views per base model",
        "views": {
          "lightgbm": "Target-history (lags/rolling stats of BQX)",
          "xgboost": "Returns/volatility (multi-horizon, ATR, range)",
          "catboost": "Cross-pair/microstructure (spreads, correlations)",
          "elasticnet": "All features (linear baseline)"
        },
        "priority": "MEDIUM"
      },
      "fix_4_probability_stacking": {
        "problem": "Stacking hard labels loses information",
        "solution": "Stack calibrated probabilities, not predictions",
        "architecture": {
          "stage_a": "Sign Probability Stack (LGB+XGB+CB → calibrated P(+))",
          "stage_b": "Conditional Magnitude (only after sign decided)"
        },
        "priority": "HIGH"
      },
      "fix_5_regime_aware": {
        "problem": "Single model doesn't adapt to market regimes",
        "solution": "Add regime features to meta-learner OR use MoE specialists",
        "regime_features": ["volatility_regime", "trend_strength", "session_indicator", "range_expansion"],
        "priority": "HIGH"
      },
      "fix_6_confidence_gating": {
        "problem": "Low-confidence predictions hurt accuracy",
        "solution": "Gate predictions with thresholds, track called accuracy",
        "thresholds": {"tau_plus": 0.65, "tau_minus": 0.35},
        "target_metrics": {"called_accuracy": "85-90%", "coverage": "30-50%"},
        "priority": "HIGH"
      }
    },
    "expected_progression": [
      {"enhancement": "Baseline", "gain": "-", "cumulative": "75-79%"},
      {"enhancement": "+Walk-Forward OOF", "gain": "+2-3%", "cumulative": "77-82%"},
      {"enhancement": "+Calibration", "gain": "+1-2%", "cumulative": "78-84%"},
      {"enhancement": "+Regime features", "gain": "+2-4%", "cumulative": "80-88%"},
      {"enhancement": "+Feature diversity", "gain": "+1-2%", "cumulative": "81-90%"},
      {"enhancement": "+Confidence gating", "gain": "+3-5%", "cumulative": "85-95% (called)"}
    ]
  },
  "feature_selection_system": {
    "version": "2.0",
    "name": "Robust Group-First Stability Selection",
    "replaces": "Naive SHAP (v1)",
    "stages": [
      {"stage": 0, "name": "Define Feature Universe", "description": "Time cutoffs, join rules, no leakage"},
      {"stage": 1, "name": "Safe Pruning", "description": "Remove constant, duplicate, >99% missing"},
      {"stage": 2, "name": "Correlation Clustering", "description": "Group features with |r| > 0.95"},
      {"stage": 3, "name": "Group-First Screening", "description": "Quick model per group, rank by AUC"},
      {"stage": 4, "name": "Stability Selection", "description": "5 folds × 3 seeds, >50% frequency (USER APPROVED 2025-12-09)"},
      {"stage": 5, "name": "Ablation Testing", "description": "Remove groups, measure ΔAUC"},
      {"stage": 6, "name": "SHAP Interpretation", "description": "Late-stage explainability only"}
    ],
    "advantages_over_v1": [
      "Prevents correlation dilution between IDX/BQX twins",
      "Selection stability across seeds/folds",
      "Never loses entire feature domains",
      "Validates importance by performance impact, not just scores"
    ]
  },
  "model_architecture": {
    "total_models": 784,
    "calculation": "28 pairs × 7 horizons × 4 ensemble members",
    "horizons": ["h15", "h30", "h45", "h60", "h75", "h90", "h105"],
    "ensemble_members": {
      "base_models": ["LightGBM", "XGBoost", "CatBoost", "ElasticNet"],
      "meta_learner": "Logistic Regression + Regime Features"
    },
    "deployment_strategy": "Deploy farthest horizon achieving ≥95% called accuracy"
  },
  "cost_optimization": {
    "monthly_estimate": "$277",
    "savings_vs_original": "63%",
    "strategies": [
      {"strategy": "BigQuery ML (vs Vertex AI)", "savings": "70%"},
      {"strategy": "Spot VMs for training", "savings": "60-90%"},
      {"strategy": "Feature selection FIRST", "savings": "90% compute"},
      {"strategy": "Coldline backup", "savings": "60%"},
      {"strategy": "V1 deletion", "savings": "$50/month realized"}
    ]
  },
  "files_created": [
    "pipelines/training/feature_selection_robust.py",
    "pipelines/training/stack_calibrated.py",
    "pipelines/training/train_multi_pair.py",
    "pipelines/training/train_meta_learner.py",
    "pipelines/training/create_materialized_features.py",
    "scripts/generate_column_catalog.py",
    "intelligence/robust_feature_selection_eurusd_h15.json",
    "mandate/FEATURE_LEDGER_100_PERCENT_MANDATE.md"
  ],
  "deprecated_files": [
    "docs/ROADMAP_*.md (v1 roadmap files)",
    "scripts/shap_feature_selection.py (replaced by robust selection)"
  ],
  "v2_1_governance_enhancements": {
    "source": "docs/roadmap_update_recommendations.md",
    "status": "RECOMMENDATIONS",
    "required_contracts": {
      "metric_contract": {
        "primary": "Balanced Sign Accuracy (positive vs negative)",
        "secondary": ["Called-signal accuracy + coverage", "Calibration (logloss/Brier + ECE)", "Magnitude (conditional on correct sign)"],
        "deliverable": "metrics_contract.md"
      },
      "persistence_contract": {
        "definition": "Meet targets in >= X of Y walk-forward windows spanning >= Z months",
        "tolerance": "Worst-window performance must not collapse > D points",
        "deliverable": "persistence_contract.md"
      }
    },
    "required_artifacts": {
      "feature_lineage_ledger": {
        "purpose": "Account for every feature and record what happened to it",
        "mandate": "/mandate/FEATURE_LEDGER_100_PERCENT_MANDATE.md",
        "mandate_date": "2025-12-09",
        "coverage_requirement": "100% - ALL 6,477 features per model must be in ledger",
        "columns": ["feature_name", "source_table", "feature_type", "feature_scope", "variant", "pair", "horizon", "model_type", "cluster_id", "group_id", "pruned_stage", "prune_reason", "screen_score", "stability_freq", "importance_mean", "importance_std", "ablation_delta", "final_status"],
        "expected_rows": 1269492,
        "calculation": "28 pairs × 7 horizons × 6,477 features",
        "shap_config": {
          "sample_size_minimum": 100000,
          "user_mandate": "100,000+ samples (BINDING)",
          "cost_impact": "$0 additional cloud cost"
        },
        "deliverable": "feature_ledger.parquet"
      },
      "leakage_guardrails": {
        "dynamic_embargo": "embargo = max_feature_lookback_intervals + horizon_buffer",
        "automated_tests": ["no t+1 data used in t row", "no centered windows / future-inclusive rolls", "scalers fit on train only", "join-time aggregation uses only past data", "label generation uses only available info"],
        "deliverable": "tests/leakage/"
      }
    },
    "phase_4_5_governance_gate": {
      "description": "Validation checkpoint before scaling to 784 models",
      "requirements": [
        "Leakage audit tests pass",
        "Metric + persistence contracts locked",
        "Thresholds selected via nested evaluation",
        "Model registry + artifact storage working",
        "Monitoring spec implemented in staging",
        "Pilot results stable across multiple regimes"
      ],
      "deliverable": "phase_4_5_gate_checklist.md"
    },
    "recommended_improvements": {
      "correlation_clustering": "Add Spearman + MI beyond Pearson r",
      "cross_group_interaction": "Pairwise group test for top N groups OR global model permutation",
      "stability_selection": "5 folds x 5-10 seeds at final stage, track variance not just mean",
      "ablation_method": "Use balanced sign accuracy + regime slices, not generic ΔAUC",
      "seed_bagging": "Train each base model with multiple seeds, average before stacking",
      "two_stage_architecture": "Stage A: Sign model, Stage B: Magnitude conditional on sign"
    },
    "artifact_deliverables": [
      "metrics_contract.md",
      "persistence_contract.md",
      "feature_ledger.parquet",
      "feature_ledger.md",
      "leakage_guardrails.md",
      "clusters.json",
      "clustering_report.md",
      "stability_selection_report.md",
      "ablation_by_regime.md",
      "stack_spec.md",
      "calibration_report.md",
      "gating_policy.md",
      "coverage_curves.md",
      "phase_4_5_gate_checklist.md",
      "monitoring_and_alerts.md",
      "model_registry.jsonl"
    ]
  },
  "user_mandates": {
    "description": "Binding user decisions that supersede all other recommendations",
    "mandates": {
      "shap_sample_size": {
        "value": 100000,
        "unit": "samples minimum",
        "approval_date": "2025-12-09",
        "binding": true,
        "rationale": "Statistical robustness for SHAP importance calculation"
      },
      "stability_threshold": {
        "value": 0.5,
        "unit": "frequency (50%)",
        "approval_date": "2025-12-09",
        "binding": true,
        "previous_value": 0.6,
        "features_recovered": 208,
        "rationale": "Include high-importance regime-specific features"
      },
      "ledger_coverage": {
        "value": "100%",
        "unit": "all 6,477 features per model",
        "approval_date": "2025-12-09",
        "binding": true,
        "rationale": "Complete audit trail for feature selection decisions"
      }
    }
  },
  "risk_register": {
    "description": "Identified risks and mitigation strategies",
    "risks": [
      {
        "id": "RISK-001",
        "description": "ElasticNet shows AUC < 0.5 (0.4578)",
        "impact": "LOW",
        "probability": "CONFIRMED",
        "mitigation": "Investigate configuration; may exclude from ensemble or use for diversity only",
        "owner": "BA",
        "status": "OPEN"
      },
      {
        "id": "RISK-002",
        "description": "Gap tables (265) block feature selection",
        "impact": "HIGH",
        "probability": "HIGH",
        "mitigation": "Prioritize CSI implementation, parallel processing authorized",
        "owner": "BA",
        "status": "IN_PROGRESS"
      },
      {
        "id": "RISK-003",
        "description": "SHAP compute time with 100K samples",
        "impact": "MEDIUM",
        "probability": "MEDIUM",
        "mitigation": "28-worker parallelization approved, batch processing for memory",
        "owner": "BA",
        "status": "MITIGATED"
      },
      {
        "id": "RISK-004",
        "description": "Feature universe not fully tested (only 15.6% tested)",
        "impact": "HIGH",
        "probability": "CONFIRMED",
        "mitigation": "Run selection on full 6,477 features after gap remediation",
        "owner": "BA",
        "status": "PLANNED"
      },
      {
        "id": "RISK-005",
        "description": "Model accuracy below 85% target",
        "impact": "HIGH",
        "probability": "MEDIUM",
        "mitigation": "Confidence gating to achieve 85-95% called accuracy; adjust coverage threshold",
        "owner": "CE",
        "status": "PLANNED"
      }
    ]
  },
  "model_versioning": {
    "scheme": "v{major}.{minor}.{patch}_{pair}_{horizon}_{timestamp}",
    "example": "v1.0.0_eurusd_h15_20251209",
    "storage": {
      "models": "gs://bqx-ml-v3-models/{pair}/{horizon}/",
      "artifacts": "gs://bqx-ml-v3-artifacts/{pair}/{horizon}/",
      "ledgers": "gs://bqx-ml-v3-ledgers/"
    },
    "retention": "Keep last 3 versions per pair-horizon",
    "registry": "model_registry.jsonl"
  },
  "backtesting_protocol": {
    "method": "Walk-forward with expanding window",
    "train_window_minimum": "6 months",
    "test_window": "1 month",
    "embargo_intervals": 30,
    "refit_frequency": "Monthly",
    "minimum_windows": 12,
    "validation_metrics": ["accuracy", "auc", "called_accuracy", "coverage", "persistence"]
  }
}
